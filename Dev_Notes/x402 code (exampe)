
/*
  <meta name="x402-protocol" content="1.0" />
  <meta name="coinbase-cdp-enabled" content="true" />
  <meta name="coinbase-cdp-network" content="base" />
  <meta name="web3-provider" content="coinbase,metamask,walletconnect" />
*/



// POST /api/articles/:id/purchase - x402 Purchase with dynamic pricing and recipients

/*
router.post('/articles/:id/purchase', criticalLimiter, async (req: Request, res: Response) => {
  try {
    const articleId = parseInt(req.params.id);
    const article = await db.getArticleById(articleId);

    if (!article) {
      return res.status(404).json({
        success: false,
        error: 'Article not found'
      });
    }

    // Check if x402 payment header is present
    const paymentHeader = req.headers['x-payment'];
    
    if (!paymentHeader) {
      // Return 402 Payment Required with x402 format
      const priceInCents = Math.round(article.price * 100);
      const priceInMicroUSDC = priceInCents * 10000; // Convert to micro USDC

      const facilitatorUrl = process.env.COINBASE_CDP_API_KEY
        ? `https://facilitator.cdp.coinbase.com`
        : process.env.X402_FACILITATOR_URL || 'https://x402.org/facilitator';

      return res.status(402).json({
        x402Version: 1,
        error: "X-PAYMENT header is required",
        accepts: [{
          scheme: "exact",
          network: process.env.X402_NETWORK || "base-sepolia",
          maxAmountRequired: priceInMicroUSDC.toString(),
          resource: `${req.protocol}://${req.get('host')}/api/articles/${articleId}/purchase`,
          description: `Purchase access to: ${article.title}`,
          mimeType: "application/json",
          payTo: article.authorAddress, // Dynamic recipient - payment goes to author!
          maxTimeoutSeconds: 60,
          asset: process.env.X402_NETWORK === 'base'
            ? "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913" // USDC Base mainnet
            : "0x036CbD53842c5426634e7929541eC2318f3dCF7e", // USDC Base Sepolia
          outputSchema: {
            input: {
              type: "http",
              method: "POST",
              discoverable: true
            }
          },
          extra: {
            name: "USDC",
            version: "2",
            // Bazaar discovery metadata
            title: `Purchase: ${article.title}`,
            category: article.categories?.[0] || "content",
            tags: article.categories || ["article", "content"],
            serviceName: "Penny.io Article Access",
            serviceDescription: `Unlock full access to "${article.title}" by ${article.authorAddress.slice(0, 6)}...${article.authorAddress.slice(-4)}`,
            pricing: {
              currency: "USD",
              amount: article.price.toString(),
              display: `$${article.price.toFixed(2)}`
            }
          }
        }]
      });
    }

    // Payment header is present - verify and process payment
    try {
      const paymentData = JSON.parse(Buffer.from(paymentHeader as string, 'base64').toString());
      
      // Verify payment (simplified for demo)
      const isValidPayment = await verifyX402Payment(paymentData, article);
      
      if (!isValidPayment) {
        return res.status(400).json({
          success: false,
          error: 'Invalid payment'
        });
      }

      // Payment verified! Update article stats
      const newPurchases = article.purchases + 1;
      const newEarnings = article.earnings + article.price;

      await db.updateArticleStats(articleId, undefined, newPurchases, newEarnings);
*/